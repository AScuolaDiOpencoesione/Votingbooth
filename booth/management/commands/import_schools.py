from django.core.management.base import BaseCommand, CommandError
from booth.models import * 
import requests

import csv
import io

"""
{'support_association_name': 'ITALIA NOSTRA ONLUS', 'support_association_letter': './LETTERA_SUPPORTO_ASSOCIAZIONE.pdf', "3.2 - Data dell'evento Open Data Day": '2017-03-06', 'support_teacher_area': 'Area Scientifica', '1 - Link al progetto scelto su OpenCoesione': 'http://www.opencoesione.gov.it/progetti/27ab4320001/', "3.2 - Locandina dell'evento organizzato": 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/0bb22619-51f2-4e94-8147-65db495706d3.Locandina%20a%20scuola%20di%20OpenCoesione.jpg', 'school_cap': '66050', 'stato_finanziamenti': 'In corso', 'R4_inviato': 'False', 'team_name': "(R)INNOVARE L'AMBIENTE", 'cup': 'J54B13001120002', '3.1 - Immagine in evidenza': 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/0a904a75-0a13-4c9c-adf8-809ec1cc7649.IMG_3980.JPG', 'tech_4': 'True', 'support_association_ref_name': 'DAVIDE AQUILANO', '1 - Canvas': 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/6ddd1bf1-8980-492a-80ba-21482e58a47b.Canavas.odt', 'school_name': 'ISTITUTO ISTRUZIONE SUPERIORE "R. MATTIOLI" ISTITUTO TECNICO ECONOMICO', 'R31_post': 'http://www.ascuoladiopencoesione.it/blogs/1/619/46460', 'support_teacher_email': 'prof.giuseppegallo@virgilio.it', 'tech_3': 'True', 'tech_2': 'True', 'tech_1': 'True', '3.2 - Tipologia di ospiti invitati': "{u'Altro': True, u'Rappresentanti della stampa locale': True, u'Esperto del tema scelto (amici di ASOC)': True, u'Esperto del tema scelto (ospite esterno)': True, u'Rappresentante istituzionale': True, u'Altre classi del vostro Iistituto': True}", '3.1 - Paragrafo 1: Descrizione generale analisi': 'DATO NON ESPORTATO', '2 - Link Fonte Istituzionale 3': 'http://www.comune.sansalvo.gov.it/', 'school_mech_spec': 'CHTD007011', 'team_twitter': '', "3.3 - Descrizione dell'evento in 700 caratteri": 'DATO NON ESPORTATO', 'support_teacher_phone': '3478733899', '1 - Immagine in evidenza': 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/bbadcd77-5b54-4ba5-812d-04c8700b0cf2.bonifica%20Bosco-Motticce.jpg', 'integration_mode': 'Alternanza scuola/lavoro', 'fin_totale_pubblico_netto': '\xc3\xa2\xc2\x82\xc2\xac 2150000,00', 'school_type_cat': 'Istituto di Istruzione Superiore', "3.2 - Informazioni per raggiungere il luogo dell'evento": "{u'geoj': [42.0436328, 14.7243321], u'addr': u'SAN SALVO (CHIETI) VIA MONTEGRAPPA 69'}", 'programma': 'POR CRO  FESR ABRUZZO', 'team_size': '14', '2 - Link altre fonti 1': 'http://sansalvo.net', '2 - Link altre fonti 3': 'http://ilcentro.gelocal.it/chieti', '2 - Link altre fonti 2': 'http://zonalocale.it', '1 - La ricerca in 140 caratteri': 'Individuazione di politiche in materia di prevenzione, riciclo, recupero e smaltimento dei rifiuti, nonch\xc3\x83\xc2\xa9 di gestione dei siti inquinati da bonificare e (r)innovare.', 'support_association_ref_email': 'davideaquilano@inwind.it', 'team_classes': '4,5', '3.2 - Orario': '09:00', 'R1_post': 'http://www.ascuoladiopencoesione.it/blogs/1/619/46458', 'R33_post': 'http://www.ascuoladiopencoesione.it/blogs/1/619/', '1 - Blog Post - raccontare la ricerca scelta': 'DATO NON ESPORTATO', '3.1 - Titolo articolo data journalism': "(R)INNOVARE L'AMBIENTE: IERI, OGGI, DOMANI.", "3.2 - Tipologia dell'evento organizzato": 'presentazione a un gruppo ristretto non pubblico', 'school_type_spec': 'None', '3.3 - Conclusioni e prossimi passi': 'DATO NON ESPORTATO', '1 - CUP (Codice Unico Progetto) del progetto scelto su OpenCoesione': 'J54B13001120002', 'support_association_statuto': './statuto_associazione.pdf', 'school_asoc_1314': 'False', 'R2_inviato': 'True', 'R4_salvato': 'False', '2 - Blog Post - raccontare la ricerca di dati e informazioni': 'DATO NON ESPORTATO', '4 - URL Monithon': '--', 'team_website': 'None', 'fondo_comunitario': 'FESR', 'school_type': 'ISTITUTO TECNICO COMMERCIALE', '1 - Tema del progetto da OpenCoesione': 'Ambiente', 'support_association_address': 'CORSO MAZZINI 320 - VASTO (CH)', 'support_association_type': 'Nuova Associazione', "3.3 - Immagine dell'evento Open Data Day": 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/3264eb13-ff09-4371-be0a-177918869d25.20170306_105343.jpg', "3.3 - Osservazioni su temi e discussioni emersi durante l'evento": 'DATO NON ESPORTATO', 'support_association_web': 'WWW.ITALIANOSTRA.OTG', 'R2_post': 'http://www.ascuoladiopencoesione.it/blogs/1/619/46459', 'school_region': 'Abruzzo', 'classificazione_qsn': "Valorizzazione delle risorse naturali e culturali per l'attrattivit\xc3\x83\xc2\xa0\xc3\x82\xc2\xa0 e lo sviluppo", 'R4_post': 'http://www.ascuoladiopencoesione.it/blogs/1/619/', 'school_province': 'Chieti', 'school_municipality': 'SAN SALVO', '2 - Link Fonte Istituzionale 2': 'http://ambiente.regione.abruzzo.it', '2 - Link Fonte Istituzionale 1': ' http://opencoesione.gov.it/', '3.3 - Rassegna stampa': '', 'team_profile_image': 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/650ef978-ba5b-4992-a9d7-148bdaffd227.RINNOVARE%20L%27AMBIENTE.jpg', 'team_type': 'Gruppo misto di classi diverse', 'natura': 'Infrastrutture', '1 - Titolo della ricerca': 'DA DISCARICA  A OASI: BOSCO MOTTICCE', 'support_edic_letter': '', '2 - Titolo del Report': "(R) INNOVARE L'AMBIENTE", 'R5_inviato': 'False', 'R1_inviato': 'True', 'R31_salvato': 'False', 'authorization': './lettera_di_adesione_ufficiale_al_progetto.pdf', '2 - La ricerca disegnata': 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/eefb1cb2-62aa-40a5-ac83-28458c6aeebf.La%20ricerca%20disegnata.docx', '3.1 - Oggetto "Embed"': 'Intervista: ', 'support_teacher_name': 'Davide ', 'R32_salvato': 'False', '3.1 - Immagine descrittiva paragrafo 2': 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/7380b849-7d27-4ddc-8568-2e16d8132ddf.documento%20dossier.pdf', '3.1 - Immagine descrittiva paragrafo 1': 'http://files.ascuoladiopencoesione.it/asoc1617/uploads/misc/70a324cb-e2f1-48aa-b642-e20bb67f0f52.IMG_20170215_121613.jpg', 'CLP': '27ab4320001', 'R5_post': 'http://www.ascuoladiopencoesione.it/blogs/1/619/', 'tema': 'Ambiente', '1 - Nome del progetto scelto su OpenCoesione': 'Comune di San Salvo - Bonifica discarica pubblica "Bosco Motticce"', 'R32_post': 'http://www.ascuoladiopencoesione.it/blogs/1/619/46461', 'R5_salvato': 'False', 'R33_inviato': 'False', '3.2 - Numero di persone coinvolte': 'da 50 a 100', 'school_address': 'VIA MONTEGRAPPA 69', 'id': '25', 'team_email': 'prof.giuseppegallo@virgilio.it', 'attivo': 'True', 'team_list': './ASOC1617_Modello_alunni.partecipanti_Gc9fdYz.xlsx', 'tech_other': 'None', 'support_association_denom': 'ITALIA NOSTRA ONLUS', 'support_edic': 'Europe Direct Teramo', 'R31_inviato': 'True', 'R2_salvato': 'False', 'applying_teacher': 'GIUSEPPE GALLO', '3.1 - Paragrafo 3: Conclusione': 'DATO NON ESPORTATO', "3.2 - Titolo dell'evento Open Data Day": "(R)INNOVARE L'AMBIENTE: IERI, OGGI, DOMANI.", 'R33_salvato': 'True', '3.3 - Rassegna stampa (immagine o pdf)': '', 'pagamento': '\xc3\xa2\xc2\x82\xc2\xac 601548,73', "1 - Natura dell'investimento da OpenCoesione": 'Infrastrutture', 'school_mech': 'CHIS00700P', '3.1 - Paragrafo 2: Elaborazione Dati': 'DATO NON ESPORTATO', 'school_asoc_1415': 'False', 'school_asoc_1516': 'False', 'R1_salvato': 'False', 'stato_progetto': 'In corso', "3.3 - Titolo dell'evento Open Data Day": "(R)INNOVARE L'AMBIENTE: IERI, OGGI, DOMANI", 'fin_totale_pubblico': '\xc3\xa2\xc2\x82\xc2\xac 2150000,00', 'R32_inviato': 'True'}
"""

url = "http://api.ascuoladiopencoesione.it/mega_export"
class Command(BaseCommand):

    def handle(self, *args, **options):
        r = requests.get(url)
        reader = csv.DictReader(io.StringIO(r.text), delimiter=";")
        ves = []
        order = 1
        for row in reader:
            ve = VotingElement()
            ve.session_id=2
            ve.name=row["id"]
            ve.repr = "%s - %s - %s(%s)" % (row["team_name"], row["school_name"], row["school_municipality"], row["school_province"] )
            print ve.repr
            ve.field = "ID_ASOC"
            ve.order = order
            order +=1
            ves.append(ve)
        print VotingElement.objects.filter(session_id=2).count()
        VotingElement.objects.filter(session_id=2).delete()
        VotingElement.objects.bulk_create(ves)
        